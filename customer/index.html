<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie at Hill - Staff Check-in</title>
  <style>
    :root {
      --primary-color: #0077cc;
      --secondary-color: #333;
      --success-bg: #e6ffea;
      --success-text: #006622;
      --warn-bg: #fff4cc;
      --warn-text: #cc8800;
      --error-bg: #ffe6e6;
      --error-text: #cc0000;
      --bg-light: #f4f7f9;
      --card-bg: #ffffff;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-light);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      max-width: 550px;
      width: 100%;
      background: var(--card-bg);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    h1 {
      font-size: 24px;
      color: var(--secondary-color);
      margin-top: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
    }
    .status-alert {
      font-weight: bold;
      margin: 20px 0;
      padding: 15px;
      border-radius: 10px;
      font-size: 16px;
      /* FIX: Removed flexbox for natural text flow */
    }
    .status-alert.error { background: var(--error-bg); color: var(--error-text); border: 1px solid var(--error-text); }
    .status-alert.warn { background: var(--warn-bg); color: var(--warn-text); border: 1px solid var(--warn-text); }
    .status-alert.success { background: var(--success-bg); color: var(--success-text); border: 1px solid var(--success-text); }
    .info-card {
      margin-top: 25px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
    }
    .info-card h2 {
      font-size: 18px;
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px dashed #eee;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }
    td {
      padding: 5px 0;
      vertical-align: top;
      font-size: 15px;
    }
    td:first-child {
      font-weight: 600;
      color: var(--secondary-color);
      width: 45%;
    }
    td:last-child {
      text-align: right;
      color: #555;
      word-break: break-word;
    }
    button {
      display: block;
      width: 100%;
      margin-top: 30px;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
    }
    button:hover:enabled {
      background: #005f99;
    }
    button:active:enabled {
      transform: translateY(1px);
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .proof-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .proof-section strong {
      display: block;
      margin-bottom: 10px;
      color: var(--secondary-color);
    }
    .proof-frame {
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
    }
    .proof-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéüÔ∏è Movie at Hill - Staff Check-in</h1>

    <div id="status" class="status-alert"></div>
    
    <div id="info" style="display:none;">
      <div class="info-card">
        <h2>Participant Details</h2>
        <table>
          <tr><td>‡∏ä‡∏∑‡πà‡∏≠ (Name)</td><td id="name"></td></tr>
          <tr><td>‡∏≠‡∏≤‡∏¢‡∏∏ (Age)</td><td id="age"></td></tr>
          <tr><td>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Total Members)</td><td id="members"></td></tr>
          <tr><td>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ä‡∏≥‡∏£‡∏∞ (Total Amount)</td><td id="totalAmount"></td></tr>
        </table>
        
        <h2>Contact & Payment</h2>
        <table>
            <tr><td>‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)</td><td id="email"></td></tr>
            <tr><td>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô (Transfer Time)</td><td id="transferTime"></td></tr>
        </table>
      </div>

      <div id="proofSection" class="proof-section" style="display:none;">
        <strong>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Payment Proof):</strong>
        <div class="proof-frame">
          <iframe id="proofIframe" allow="autoplay"></iframe>
        </div>
      </div>
    </div>
    
    <button id="checkinBtn" style="display:none;">‚úÖ Perform Check In</button>
  </div>

  <script>
    // Utility to get URL parameter
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // Function to render HTML for a data field
    function setField(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value || '-';
    }

    // Main initialization function
    async function init() {
      const uuid = getUrlParameter("uuid");
      const statusEl = document.getElementById("status");
      const infoEl = document.getElementById("info");
      const checkinBtn = document.getElementById("checkinBtn");

      if (!uuid) {
        statusEl.innerHTML = "‚ùå <strong>Invalid Request:</strong> Missing UUID parameter.";
        statusEl.className = "status-alert error";
        return;
      }
      
      // Initial loading state
      statusEl.innerHTML = "‚åõ <strong>Loading Data...</strong> Please wait.";
      statusEl.className = "status-alert warn";

      try {
        const fetchUrl = `https://n8n.netkubb.com/webhook/movieathill?uuid=${uuid}`;
        const res = await fetch(fetchUrl);
        
        if (!res.ok) throw new Error("API request failed with status " + res.status);
        
        const data = await res.json();

        // 1. **Validation: Valid UUID/Data Found**
        if (!data || !data.UUID || data.UUID !== uuid) {
          statusEl.innerHTML = "‚ùå <strong>UUID Not Found:</strong> Participant data could not be retrieved.";
          statusEl.className = "status-alert error";
          return;
        }

        // --- Display Participant Info ---
        infoEl.style.display = "block";
        
        const members = Number(data["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)"]) || 1; 
        let price = 250;
        if(data["‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤"].split(",")[0].split("/").reverse().join("") <= 20251115){
          price = 200
        }
        const totalAmount = members * price;
        
        setField("name", data["‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• "]);
        setField("age", data["‡∏≠‡∏≤‡∏¢‡∏∏"]);
        // REMOVED: setField("gender", data["‡πÄ‡∏û‡∏®"]);
        setField("members", members);
        setField("totalAmount", totalAmount.toLocaleString() + " ‡∏ö‡∏≤‡∏ó");
        setField("email", data["‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•"]);
        setField("transferTime", data["‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"]);

        // Embed Google Drive proof (if available)
        if (data["‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô"]) {
          const proofUrl = data["‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô"];
          // Convert Google Drive "open?id=" links to "file/d/{id}/preview" format
          const embedUrl = proofUrl
            .replace("open?id=", "file/d/")
            .replace(/(&.*)?$/, "/preview"); // Removes any extra parameters like &usp=drivesdk

          document.getElementById("proofIframe").src = embedUrl;
          document.getElementById("proofSection").style.display = "block";
        }
        
        // 2. **Validation: Payment Status (Is Confirm)**
        const isPaid = data["Is Confirm"];
        const isCheckedIn = data["Is Check In"];

        if (!isPaid) {
          // FIXED: Simplified the message and structure for clean, natural wrapping.
          statusEl.innerHTML = `
            ‚ö†Ô∏è <strong>PENDING PAYMENT:</strong> Participant has not been confirmed as paid (<code>Is Confirm: false</code>). 
            <strong>DO NOT CHECK IN.</strong>
          `;
          statusEl.className = "status-alert error";
          checkinBtn.style.display = "block";
          checkinBtn.disabled = true;
          checkinBtn.textContent = "Payment Not Confirmed";
        } 
        
        // 3. **Validation: Check-in Status (Is Check In)**
        else if (isCheckedIn) {
          statusEl.innerHTML = "‚úÖ <strong>CHECKED IN:</strong> This participant has already been checked in. Members: <strong>" + members + "</strong>.";
          statusEl.className = "status-alert warn";
          checkinBtn.style.display = "block";
          checkinBtn.disabled = true;
          checkinBtn.textContent = "Already Checked In";
        } 
        
        // 4. **Success State: Ready for Check-in**
        else {
          statusEl.innerHTML = "üü¢ <strong>READY TO CHECK IN:</strong> Payment confirmed. Members: <strong>" + members + "</strong>.";
          statusEl.className = "status-alert success";
          checkinBtn.style.display = "block";
          checkinBtn.disabled = false;
        }

        // --- Check-in button handler ---
        checkinBtn.onclick = async () => {
          if (isCheckedIn || !isPaid) return;
          
          checkinBtn.disabled = true;
          checkinBtn.textContent = "Processing Check-in...";
          statusEl.innerHTML = "‚åõ <strong>Checking In...</strong>";
          statusEl.className = "status-alert warn";

          try {
            const checkinUrl = data["Check in URL"];
            // Fallback for check-in URL
            const finalCheckinUrl = checkinUrl || `https://n8n.netkubb.com/webhook-test/movieathill/checkin?uuid=${uuid}`;

            const res = await fetch(finalCheckinUrl);
            
            if (res.ok) {
              statusEl.innerHTML = "üéâ <strong>SUCCESS!</strong> Participant <strong>" + data["‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• "] + "</strong> checked in.";
              statusEl.className = "status-alert success";
              checkinBtn.style.display = "none";
            } else {
              throw new Error("Check-in API call failed.");
            }
          } catch (e) {
            console.error("Check-in Error:", e);
            statusEl.innerHTML = "‚ùå <strong>CHECK-IN FAILED:</strong> An error occurred during the check-in process. Try again or contact support.";
            statusEl.className = "status-alert error";
            checkinBtn.disabled = false;
            checkinBtn.textContent = "‚ö†Ô∏è Check In Failed - Try Again";
          }
        };

      } catch (err) {
        console.error("Initialization Error:", err);
        statusEl.innerHTML = "‚ùå <strong>SYSTEM ERROR:</strong> Could not connect to the data service. " + (uuid ? `(UUID: ${uuid})` : '');
        statusEl.className = "status-alert error";
      }
    }

    init();
  </script>
</body>
</html>